{% extends "partials/case-details.njk" %}

{%- set communityData = data.communityData -%}
{%- set activeOrders = [] -%}
{%- set previousOrders = [] -%}
{%- for order in communityData.convictions if communityData.convictions | length %}
    {% if order.active %}
        {{ activeOrders.push(order) }}
    {% else %}
        {{ previousOrders.push(order) }}
    {% endif %}
{% endfor -%}

{%- set offenderManager = {} -%}
{%- for manager in communityData.personalDetails.offenderManagers if communityData.personalDetails.offenderManagers | length %}
    {% if manager.active %}
        {%- set offenderManager = manager -%}
    {% endif %}
{% endfor -%}

{% block caseContent %}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

            {% if activeOrders | length %}
                <h2 class="govuk-heading-m">Current orders ({{ activeOrders | length }})</h2>
                {%- for order in activeOrders %}
                    {% if order.sentence %}
                        <p class="govuk-body govuk-!-margin-bottom-0"><a href="record/{{ order.convictionId }}" class="govuk-link govuk-link--no-visited-state govuk-!-font-weight-bold">{{ order.sentence.description }}</a></p>
                        <p class="govuk-body govuk-!-margin-top-1 govuk-!-margin-bottom-0">{{ order.offences[0].detail.description }}</p>
                        <p class="govuk-hint govuk-!-margin-top-1 govuk-!-margin-bottom-0">Started on {{ params.moment(order.referralDate, 'YYYY-MM-DD').format('D MMM YYYY') }}</p>

                        <table class="govuk-table govuk-!-margin-top-4">
                            <thead class="govuk-table__head">
                                <tr class="govuk-table__row">
                                    <th scope="col" class="govuk-table__header">Requirement</th>
                                    <th scope="col" class="govuk-table__header">Length</th>
                                </tr>
                            </thead>
                            <tbody class="govuk-table__body">
                                <tr class="govuk-table__row">
                                    <td class="govuk-table__cell">Rehabilitation Activity Requirement (RAR)</td>
                                    <td class="govuk-table__cell">20 days</td>
                                </tr>
                                <tr class="govuk-table__row">
                                    <td class="govuk-table__cell">Court - Accredited Programme - Building Better Relationships (BBR)</td>
                                    <td class="govuk-table__cell">-</td>
                                </tr>
                                <tr class="govuk-table__row">
                                    <td class="govuk-table__cell">Unpaid Work - Regular</td>
                                    <td class="govuk-table__cell">40 hours</td>
                                </tr>
                            </tbody>
                        </table>
                    {% endif %}
                {% endfor -%}
            {% endif %}

            {% if previousOrders | length %}
                <h2 class="govuk-heading-m{% if activeOrders | length and previousOrders | length %} govuk-!-margin-top-8{% endif %}">Previous orders ({{ previousOrders | length }})</h2>
                <table class="govuk-table">
                    <tbody class="govuk-table__body">
                        {%- for order in previousOrders %}
                            {% if order.sentence %}
                            <tr class="govuk-table__row">
                                <td class="govuk-table__cell govuk-!-width-two-thirds">
                                    <p class="govuk-body govuk-!-margin-bottom-0"><a href="record/{{ order.convictionId }}" class="govuk-link govuk-link--no-visited-state govuk-!-font-weight-bold">{{ order.sentence.description }}</a></p>
                                    <p class="govuk-hint govuk-!-margin-top-0 govuk-!-margin-bottom-0">{{ order.offences[0].detail.description }}</p>
                                </td>
                                <td class="govuk-table__cell govuk-table__cell--numeric govuk-!-width-one-third" style="vertical-align: bottom">
                                    <p class="govuk-hint govuk-!-margin-bottom-0">Ended on {{ params.moment(order.terminatedDate, 'YYYY-MM-DD').format('D MMM YYYY') }}</p>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor -%}
                    </tbody>
                </table>
            {% endif %}

        </div>
        <div class="govuk-grid-column-one-third">

            <h3 class="govuk-heading-s">Offender Manager</h3>

            {% if offenderManager.active %}
                <p class="govuk-body govuk-!-margin-bottom-0">{{ offenderManager.staff.forenames }} {{ offenderManager.staff.surname }}</p>
                <p class="govuk-hint govuk-!-margin-top-1">Allocated on {{ params.moment(offenderManager.fromDate, 'YYYY-MM-DD').format('D MMM YYYY') }}</p>

                <p class="govuk-body govuk-!-margin-top-0">{{ offenderManager.probationArea.description }}<br/>
                {{ offenderManager.address.buildingName }}<br/>
                {{ offenderManager.address.addressNumber }} {{ offenderManager.address.streetName }}<br/>
                {{ offenderManager.address.town }}<br/>
                {{ offenderManager.address.county }}<br/>
                {{ offenderManager.address.postcode }}</p>

                <p class="govuk-body">Telephone: {{ offenderManager.team.telephone }}</p>
            {% else %}
                <p class="govuk-body">Not active</p>
            {% endif %}

        </div>
    </div>

{% endblock %}
