{%- set hideSubnav = true -%}
{% extends "./partials/case-details.njk" %}

{%- set communityData = data.communityData -%}
{%- set currentOrder = {} -%}
{%- for order in communityData.convictions if communityData.convictions | length %}
    {% if order.convictionId | string === params.detail | string %}
        {%- set currentOrder = order -%}
    {% endif %}
{% endfor -%}

{%- set moment = params.moment -%}
{%- set preciseDiff = params.preciseDiff -%}

{% if currentOrder.active %}
    {%- set elapsedTime = params.getMonthsAndDays(moment(currentOrder.convictionDate, 'YYYY-MM-DD'), moment()) -%}
{% else %}
    {%- set elapsedTime = params.getMonthsAndDays(moment(currentOrder.convictionDate, 'YYYY-MM-DD'), moment(currentOrder.terminatedDate, 'YYYY-MM-DD')) -%}
{% endif %}

{% if currentOrder.active %}
    {# Group appointments by attended/absent and complied/failed #}
    {%- set attendances = communityData.attendanceDetails.attendances or [] -%}
    {%- set attendedAppointments = {
        complied: [],
        failed: []
    } -%}
    {%- set absentAppointments = {
        complied: [],
        failed: []
    } -%}
    {%- set awaitingOutcome = [] -%}
    {% for attended, attendances in attendances | groupby("attended") %}
        {% for complied, attendance in attendances | groupby("complied") %}
            {% if attended | string === "true" %}
                {{ attendedAppointments.complied.push(attendance) if complied | string === "true" }}
                {{ attendedAppointments.failed.push(attendance) if complied | string === "false" }}
            {% elif attended | string === "false" %}
                {{ absentAppointments.complied.push(attendance) if complied | string === "true" }}
                {{ absentAppointments.failed.push(attendance) if complied | string === "false" }}
            {% else %}
                {{ awaitingOutcome.push(attendance) }}
            {% endif %}
        {% endfor %}
    {% endfor %}

    {# Create simplified appointments for sorting and display #}
    {%- set attendedComplied = [] -%}
    {%- set absentComplied = [] -%}
    {%- set attendedFailed = [] -%}
    {%- set absentFailed = [] -%}
    {% for description, complied in attendedAppointments.complied.flat(Infinity) | groupby(params.getPath("contact.description")) %}
        {{ attendedComplied.push({
            count: complied.length,
            description: description
        }) }}
    {% endfor %}
    {% for description, complied in absentAppointments.complied.flat(Infinity) | groupby(params.getPath("outcome.description")) %}
        {{ absentComplied.push({
            count: complied.length,
            description: description
        }) }}
    {% endfor %}
    {% for description, failed in attendedAppointments.failed.flat(Infinity) | groupby(params.getPath("contact.description")) %}
        {{ attendedFailed.push({
            count: failed.length,
            description: description
        }) }}
    {% endfor %}
    {% for description, failed in absentAppointments.failed.flat(Infinity) | groupby(params.getPath("contact.description")) %}
        {{ absentFailed.push({
            count: failed.length,
            description: description
        }) }}
    {% endfor %}
{% endif %}

{% block caseContent %}

    {%- from "govuk/components/back-link/macro.njk" import govukBackLink -%}
    {{ govukBackLink({
        classes: 'govuk-!-margin-top-0 govuk-!-margin-bottom-7',
        text: "Back to probation record",
        href: '/case/' + data.caseNo + '/record'
    }) }}

    <h2 class="govuk-heading-l govuk-!-margin-0">{{ currentOrder.sentence.description }}</h2>

    <div class="govuk-grid-row govuk-!-margin-top-4">
        <div class="govuk-grid-column-two-thirds">

            <p class="govuk-body govuk-!-margin-top-1 govuk-!-margin-bottom-0">{{ currentOrder.offences[0].detail.description }}</p>

            <div class="govuk-grid-row">
                <div class="govuk-grid-column-one-third">
                    <p class="govuk-hint govuk-!-margin-bottom-0">Started</p>
                    <p class="govuk-body-l govuk-!-font-weight-bold govuk-!-margin-0 qa-start-date">{{ moment(currentOrder.convictionDate, 'YYYY-MM-DD').format('D MMM YYYY') }}</p>
                </div>
                <div class="govuk-grid-column-one-third">
                    <p class="govuk-hint govuk-!-margin-bottom-0">{{ "Ends" if currentOrder.active else "Ended" }}</p>
                    <p class="govuk-body-l govuk-!-font-weight-bold govuk-!-margin-0 qa-end-date">{{ moment(currentOrder.expectedEndDate, 'YYYY-MM-DD').format('D MMM YYYY') if currentOrder.terminationDate else moment(currentOrder.expectedEndDate, 'YYYY-MM-DD').format('D MMM YYYY') }}</p>
                </div>
                <div class="govuk-grid-column-one-third">
                    <p class="govuk-hint govuk-!-margin-bottom-0">Time elapsed</p>
                    <p class="govuk-body-l govuk-!-font-weight-bold govuk-!-margin-0 qa-elapsed-time">{{ elapsedTime }}</p>
                </div>
            </div>

        </div>
        <div class="govuk-grid-column-one-third">&nbsp;</div>
    </div>

    {% if currentOrder.active %}

        <h2 class="govuk-heading-m govuk-!-margin-top-8">Appointment attendance</h2>

        {% if attendances.length %}
            {% set sortedAttendances = attendances | sort(true, false, 'attendanceDate') %}
            <p class="govuk-body">Last attendance: {{ params.moment(sortedAttendances[0].attendanceDate, 'YYYY-MM-DD').format('D MMM YYYY') }} - {{ sortedAttendances[0].contact.description }} ({{ "Attended" if sortedAttendances[0].attended else "Absent" }} - {{ "Complied" if sortedAttendances[0].complied else "Failed to comply" }})</p>
        {% endif %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-quarter">
                <h3 class="govuk-heading-s govuk-!-margin-bottom-0">Appointments to date</h3>
            </div>
            <div class="govuk-grid-column-three-quarters">
                <p class="govuk-heading-m app-dashboard-count govuk-!-margin-bottom-0">{{ attendances | length }}</p>
            </div>
        </div>

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible app-section-break--heavy govuk-!-width-two-thirds">

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-quarter">
                <h3 class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Complied</h3>
            </div>
            <div class="govuk-grid-column-three-quarters">
                <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-0"><span class="govuk-heading-m app-dashboard-count">{{ attendedAppointments.complied.flat(Infinity) | length }}</span>Attendances</p>

                {% for complied in attendedComplied | sort(true, false, 'count') %}
                    <p class="govuk-body govuk-!-margin-0"><span class="govuk-body app-dashboard-count">{{ complied.count }}</span>{{ complied.description }}</p>
                {% endfor %}

                <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-0 govuk-!-margin-top-2"><span class="govuk-heading-m app-dashboard-count">{{ absentAppointments.complied.flat(Infinity) | length }}</span>Absences</p>

                {% for complied in absentComplied | sort(true, false, 'count') %}
                    <p class="govuk-body govuk-!-margin-0"><span class="govuk-body app-dashboard-count">{{ complied.count }}</span>{{ complied.description }}</p>
                {% endfor %}

            </div>
        </div>

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-width-two-thirds">

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-quarter">
                <h3 class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Failures to comply</h3>
            </div>
            <div class="govuk-grid-column-three-quarters">
                <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-0"><span class="govuk-heading-m app-dashboard-count">{{ attendedAppointments.failed.flat(Infinity) | length }}</span>Attendances</p>

                {% for failed in attendedFailed | sort(true, false, 'count') %}
                    <p class="govuk-body govuk-!-margin-0"><span class="govuk-body app-dashboard-count">{{ failed.count }}</span>{{ failed.description }}</p>
                {% endfor %}

                <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-0 govuk-!-margin-top-2"><span class="govuk-heading-m app-dashboard-count">{{ absentAppointments.failed.flat(Infinity) | length }}</span>Absences</p>

                {% for failed in absentFailed | sort(true, false, 'count') %}
                    <p class="govuk-body govuk-!-margin-0"><span class="govuk-body app-dashboard-count">{{ failed.count }}</span>{{ failed.description }}</p>
                {% endfor %}
            </div>
        </div>

        {% if awaitingOutcome.length %}
            <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-width-two-thirds">

            <div class="govuk-grid-row">
                <div class="govuk-grid-column-one-quarter">
                    <h3 class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-0">Awaiting outcome</h3>
                </div>
                <div class="govuk-grid-column-three-quarters">
                    <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-0"><span class="govuk-heading-m app-dashboard-count">{{ awaitingOutcome | length }}</span></p>
                </div>
            </div>
        {% endif %}

    {% endif %}

{% endblock %}
