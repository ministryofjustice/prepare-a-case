{%- set moment = params.moment -%}

{% set tableData = {
    head: [
        { text: "Defendant" },
        { text: "Probation status" },
        { text: "Offence" },
        { text: "Listing" },
        { text: "Session" },
        { text: "Court", format: "numeric" }
    ],
    rows: []
} %}

{% for item in data %}

  {% set offences = [] %}
  {% if item.offences | length === 1 %}
      {% for offence in item.offences %}
          {{ offences.push(offence.offenceTitle |  escape) }}
      {% endfor %}
  {% elif item.offences | length %}
    {{ offences.push('<ol class="govuk-list govuk-list--number govuk-!-margin-bottom-0">') }}
    {% for offence in item.offences %}
      {{ offences.push('<li>' + offence.offenceTitle |  escape + '</li>') }}
    {% endfor %}
    {{ offences.push('</ol>') }}
  {% endif %}
  {{ tableData.rows.push([
    { text: ('<a href="/case/' + item.caseNo + '/details" class="pac-defendant-link govuk-link govuk-link--no-visited-state">' + item.defendantName | escape + '</a>') | safe },
    { text: ('<div>' + ('<span class="moj-badge moj-badge--black pac-badge">Breach</span>' | safe if item.breach) + ('<span class="moj-badge moj-badge--black pac-badge" style="">Sso</span>' | safe if item.suspendedSentenceOrder) + '</div>'+ item.probationStatus + ('<span data-cy="previously-known-termination-date" class="govuk-caption-m">Order ended ' + moment(item.previouslyKnownTerminationDate).format("D MMMM YYYY") | escape + '</span>' if item.previouslyKnownTerminationDate)) | safe },
    { text: offences | join('') | safe },
    { text: item.listNo },
    { text: item.session | capitalize },
    { text: item.courtRoom, format: "numeric" }
  ]) }}

{% endfor %}

{% set maxPagesDisplay = 5 %}
{% set currentPage = params.page %}
{% set startNum = currentPage - ((maxPagesDisplay - 1) / 2) %}
{% set endNum = currentPage + ((maxPagesDisplay - 1) / 2) %}
{% set totalPages = (params.total / params.limit) | round(0, "ceil") %}

{% if startNum < 1 or totalPages <= maxPagesDisplay %}
    {% set startNum = 1 %}
    {% set endNum = maxPagesDisplay %}
    {% elif endNum > totalPages %}
    {% set startNum = totalPages - (maxPagesDisplay - 1) %}
{% endif %}

{% if endNum > totalPages %}
    {% set endNum = totalPages %}
{% endif %}

{% set pageItems = [] %}
{% for i in range(startNum, endNum + 1) -%}
    {{ pageItems.push({
        text: i,
        href: '?page=' + i,
        selected: currentPage === i
    }) }}
{%- endfor %}

{% if currentPage === 1 %}
    {% set previousLink = null %}
{% else %}
    {% set previousLink = {
        text: 'Previous',
        href: '?page=' + (currentPage - 1)
    } %}
{% endif %}

{% if currentPage === totalPages %}
    {% set nextLink = null %}
{% else %}
    {% set nextLink = {
        text: 'Next',
        href: '?page=' + (currentPage + 1)
    } %}
{% endif %}

{% extends "partials/layout.njk" %}

{% block content %}

    {% set dateFormat = 'dddd D MMM' %}
    {% set currentDate = moment(params.date, 'YYYY-MM-DD') %}
    {% set today = moment().format('YYYY-MM-DD') %}
    {% set tomorrow = moment().add(1, 'days').format('YYYY-MM-DD') %}
    {% set withinDateRange = currentDate.isBetween(moment(), params.addBusinessDays(moment(), params.totalDays - 1), 'day', '[)') %}
    {% set lastUpdated = moment(params.lastUpdated).format('[Last updated] ' + dateFormat + ' [at] hh:mm') %}

    <h1 class="qa-case-list-day govuk-heading-xl govuk-!-margin-bottom-0">
        <span class="govuk-caption-xl">Cases</span>
        {% if params.date === today %}
            Today
        {% elseif params.date === tomorrow %}
            Tomorrow
        {% else %}
            {{ currentDate.format(dateFormat) }}
        {% endif %}
    </h1>

    <p class="govuk-!-margin-bottom-7">
    {% if currentDate.isAfter(moment()) %}
        <a class="pac-pagination-link govuk-!-margin-right-5" href="/cases/{{ params.addBusinessDays(currentDate, -1).format('YYYY-MM-DD') }}">
            <svg class="pac-pagination-link--icon" xmlns="http://www.w3.org/2000/svg" height="13" width="17" viewBox="0 0 17 13">
                <path fill="currentColor" d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
            </svg>
            <span class="pac-pagination-link---text">Previous day</span>
        </a>
    {% endif %}
    {% if withinDateRange %}
        <a class="pac-pagination-link" href="/cases/{{ params.addBusinessDays(currentDate, 1).format('YYYY-MM-DD') }}">
            <span class="pac-pagination-link---text">Next day</span>
            <svg class="pac-pagination-link--icon" xmlns="http://www.w3.org/2000/svg" height="13" width="17" viewBox="0 0 17 13">
                <path fill="currentColor" d="m10.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
            </svg>
        </a>
    {% endif %}
    </p>

    <span class="govuk-caption-m pac-last-updated">{{ lastUpdated }}</span>

    {%- from "components/filter/macro.njk" import pacFilter -%}
    {{ pacFilter({
        formName: 'listFilterForm',
        filters: params.filters
    }) }}

    {% if tableData.rows | length %}
        {% block table %}
                <span class="govuk-heading-m">{{ params.total }} Cases</span>
            {%- from "govuk/components/table/macro.njk" import govukTable -%}
            {{ govukTable(tableData) }}
        {% endblock %}
    {% else %}
        <p class="govuk-body">No case data available for this day.</p>
    {% endif %}

    {% if totalPages > 1 %}
        {% block pagination %}
            {%- from "moj/components/pagination/macro.njk" import mojPagination -%}
            {{ mojPagination({
                results: {
                    from: params.from + 1,
                    to: params.to,
                    count: params.total
                },
                previous: previousLink,
                next: nextLink,
                items: pageItems
            }) }}
        {% endblock %}
    {% endif %}

{% endblock %}
